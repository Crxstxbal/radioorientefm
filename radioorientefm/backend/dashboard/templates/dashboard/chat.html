{% extends 'dashboard/base.html' %}
{% block page_title %}Moderación del Chat{% endblock %}

{% block content %}
<style>
  /* Text color classes */
  .text-primary-dark {
    color: var(--text-primary);
  }

  .text-secondary-dark {
    color: var(--text-secondary);
  }

  .text-tertiary-dark {
    color: var(--text-tertiary);
  }

  .chat-card {
    border: none;
    border-radius: 16px;
    box-shadow: var(--card-shadow);
    background: var(--card-bg);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .chat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .stat-card-chat {
    border: none;
    border-radius: 16px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s ease;
  }

  .stat-card-chat:hover {
    transform: translateY(-4px);
  }

  .stat-card-chat .icon-wrapper {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items-center;
    justify-content: center;
    font-size: 24px;
    margin-bottom: 16px;
  }

  .stat-card-chat .icon-wrapper i {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    line-height: 0;
  }

  .stat-card-chat .icon-wrapper i::before {
    display: block;
  }

  .stat-card-chat h3 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: var(--text-primary);
  }

  .stat-card-chat p {
    margin: 0;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-chat-1 {
    background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
  }

  .stat-chat-1 .icon-wrapper {
    background: linear-gradient(135deg, #60A5FA 0%, #3B82F6 100%);
    color: white;
  }

  .stat-chat-2 {
    background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
  }

  .stat-chat-2 .icon-wrapper {
    background: linear-gradient(135deg, #34D399 0%, #10B981 100%);
    color: white;
  }

  .stat-chat-3 {
    background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);
  }

  .stat-chat-3 .icon-wrapper {
    background: linear-gradient(135deg, #818CF8 0%, #6366F1 100%);
    color: white;
  }

  .stat-chat-4 {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
  }

  .stat-chat-4 .icon-wrapper {
    background: linear-gradient(135deg, #F87171 0%, #EF4444 100%);
    color: white;
  }

  .filter-btn {
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 600;
    border: 2px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-secondary);
    transition: all 0.2s ease;
  }

  .filter-btn:hover {
    border-color: #6366F1;
    color: #6366F1;
  }

  .filter-btn.active {
    background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
    color: white;
    border-color: #6366F1;
  }

  .message-bubble {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
    border: 2px solid transparent;
  }

  .message-bubble:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-color);
    transform: translateX(4px);
  }

  .message-avatar {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: linear-gradient(135deg, #818CF8 0%, #6366F1 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .message-actions {
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .message-bubble:hover .message-actions {
    opacity: 1;
  }

  .btn-action-message {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    transition: all 0.2s ease;
    margin: 0 2px;
  }

  .btn-action-block {
    background: #FEF3C7;
    color: #F59E0B;
  }

  .btn-action-block:hover {
    background: #F59E0B;
    color: white;
  }

  .btn-action-delete {
    background: #FEE2E2;
    color: #EF4444;
  }

  .btn-action-delete:hover {
    background: #EF4444;
    color: white;
  }

  .search-box-chat {
    border-radius: 12px;
    border: 2px solid var(--border-color);
    padding: 12px 20px;
    transition: all 0.3s ease;
    background: var(--card-bg);
    color: var(--text-primary);
  }

  .search-box-chat:focus {
    border-color: #6366F1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    outline: none;
    background: var(--card-bg);
    color: var(--text-primary);
  }

  .btn-moderation {
    border-radius: 10px;
    padding: 12px;
    font-weight: 600;
    border: 2px solid var(--border-color);
    background: var(--card-bg);
    transition: all 0.2s ease;
  }

  .btn-moderation:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .btn-moderation-warning {
    border-color: #FBBF24;
    color: #F59E0B;
  }

  .btn-moderation-warning:hover {
    background: #FBBF24;
    color: white;
    border-color: #FBBF24;
  }

  .btn-moderation-info {
    border-color: #60A5FA;
    color: #3B82F6;
  }

  .btn-moderation-info:hover {
    background: #60A5FA;
    color: white;
    border-color: #60A5FA;
  }

  .user-item {
    background: var(--card-bg);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
  }

  .user-item:hover {
    background: var(--bg-tertiary);
    transform: translateX(4px);
  }

  .user-avatar-small {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: linear-gradient(135deg, #34D399 0%, #10B981 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
  }

  .pagination {
    gap: 8px;
  }

  .pagination .page-link {
    border: none;
    border-radius: 10px;
    color: var(--text-secondary);
    font-weight: 600;
    padding: 10px 16px;
    transition: all 0.2s ease;
    background: var(--card-bg);
  }

  .pagination .page-link:hover {
    background: #6366F1;
    color: white;
  }

  .pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
    color: white;
  }

  .modal-header-elegant {
    border-radius: 16px 16px 0 0;
    border: none;
  }

  .modal-content-elegant {
    border-radius: 16px;
    border: none;
    background: var(--card-bg);
    color: var(--text-primary);
  }
</style>

<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-2 text-primary-dark" style="font-weight: 700;">
        <i class="fas fa-comments me-2" style="color: #6366F1;"></i>
        Moderación del Chat en Vivo
      </h2>
      <p class="text-muted mb-0">Administra mensajes y usuarios del chat</p>
    </div>
    <div class="btn-group" role="group">
      <button type="button" class="filter-btn active" id="btnTodos" onclick="filterMessages('all')">
        <i class="fas fa-list me-2"></i>Todos
      </button>
      <button type="button" class="filter-btn" id="btnBloqueados" onclick="filterMessages('blocked')">
        <i class="fas fa-ban me-2"></i>Bloqueados
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card-chat stat-chat-1">
        <div class="icon-wrapper">
          <i class="fas fa-comments"></i>
        </div>
        <h3>{{ messages_today }}</h3>
        <p>Mensajes Hoy</p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card-chat stat-chat-2">
        <div class="icon-wrapper">
          <i class="fas fa-users"></i>
        </div>
        <h3>{{ active_users_today }}</h3>
        <p>Usuarios Activos</p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card-chat stat-chat-3">
        <div class="icon-wrapper">
          <i class="fas fa-history"></i>
        </div>
        <h3>{{ messages|length }}</h3>
        <p>Mensajes Recientes</p>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card-chat stat-chat-4">
        <div class="icon-wrapper">
          <i class="fas fa-trash"></i>
        </div>
        <h3 id="deletedMessagesCount">0</h3>
        <p>Eliminados Hoy</p>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Mensajes del chat -->
    <div class="col-lg-8 mb-4">
      <div class="chat-card">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0 text-primary-dark" style="font-weight: 600;">
              <i class="fas fa-comment-dots me-2" style="color: #6366F1;"></i>
              Mensajes del Chat
            </h5>
            <div style="width: 300px;">
              <div class="input-group">
                <span class="input-group-text bg-inherit border-end-0" style="border-radius: 12px 0 0 12px; border: 2px solid var(--border-color); border-right: none; background: var(--card-bg);">
                  <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control search-box-chat border-start-0 ps-0" style="border-left: none; border-radius: 0 12px 12px 0;" placeholder="Buscar mensajes..." id="searchMessages">
              </div>
            </div>
          </div>

          <div style="max-height: 600px; overflow-y: auto;" id="messagesContainer">
            {% for message in messages %}
            <div class="message-bubble message-item" id="message-{{ message.id }}">
              <div class="d-flex">
                <div class="message-avatar me-3">
                  {{ message.usuario_nombre|default:"?"|slice:":2"|upper }}
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <strong class="text-primary-dark" style="font-size: 0.95rem;">{{ message.usuario_nombre|default:"Usuario anónimo" }}</strong>
                      <br><small class="text-muted" style="font-size: 0.8rem;">
                        <i class="fas fa-hashtag me-1"></i>{{ message.sala|default:"radio-oriente" }} •
                        <i class="fas fa-clock me-1"></i>hace {{ message.fecha_envio|timesince }}
                      </small>
                    </div>
                    <div class="message-actions">
                      <button class="btn btn-action-message btn-action-block toggle-block-btn"
                              data-user-id="{{ message.usuario.id }}"
                              data-user-name="{{ message.usuario_nombre }}"
                              data-blocked="false"
                              title="Bloquear usuario">
                        <i class="fas fa-ban"></i>
                      </button>
                      <button class="btn btn-action-message btn-action-delete delete-message-btn"
                              data-message-id="{{ message.id }}"
                              title="Eliminar mensaje">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <p class="mb-0 text-primary-dark" style="line-height: 1.5;">{{ message.contenido|safe }}</p>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
              <i class="fas fa-comments fa-4x text-muted mb-3 d-block"></i>
              <p class="text-muted mb-0">No hay mensajes en el chat</p>
            </div>
            {% endfor %}
          </div>

          <div id="messagesPaginationContainer" class="mt-4"></div>
        </div>
      </div>
    </div>

    <!-- Panel lateral -->
    <div class="col-lg-4">
      <!-- Herramientas de Moderación -->
      <div class="chat-card mb-4">
        <div class="card-body p-4">
          <h5 class="mb-3 text-primary-dark" style="font-weight: 600;">
            <i class="fas fa-shield-alt me-2" style="color: #10B981;"></i>
            Herramientas
          </h5>
          <div class="d-grid gap-2">
            <button class="btn btn-moderation btn-moderation-warning w-100" onclick="clearAllMessages()">
              <i class="fas fa-broom me-2"></i>Limpiar Chat
            </button>
            <button class="btn btn-moderation btn-moderation-info w-100" onclick="openFilterConfig()">
              <i class="fas fa-robot me-2"></i>Filtros ML
            </button>
          </div>
        </div>
      </div>

      <!-- Usuarios Más Activos -->
      <div class="chat-card">
        <div class="card-body p-4">
          <h5 class="mb-3 text-primary-dark" style="font-weight: 600;">
            <i class="fas fa-star me-2" style="color: #FBBF24;"></i>
            Usuarios Activos
          </h5>
          <div id="topUsersContainer">
            {% for user in top_users %}
            <div class="user-item">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div class="user-avatar-small me-3">
                    {{ user.username|slice:":2"|upper }}
                  </div>
                  <div>
                    <strong class="text-primary-dark" style="font-size: 0.9rem;">{{ user.username }}</strong>
                    <br><small class="text-muted" style="font-size: 0.75rem;">
                      <i class="fas fa-comment me-1"></i>{{ user.message_count }} mensaje{{ user.message_count|pluralize:"s" }}
                    </small>
                  </div>
                </div>
                <button class="btn btn-sm {% if user.is_blocked %}btn-success{% else %}btn-danger{% endif %} toggle-block-btn"
                        style="border-radius: 8px;"
                        data-user-id="{{ user.id }}"
                        data-user-name="{{ user.username }}"
                        data-blocked="{{ user.is_blocked|yesno:'true,false' }}">
                  <i class="fas fa-{% if user.is_blocked %}unlock{% else %}ban{% endif %}"></i>
                </button>
              </div>
            </div>
            {% empty %}
            <div class="text-center py-4">
              <i class="fas fa-users fa-3x text-muted mb-2"></i>
              <p class="text-muted mb-0">No hay usuarios activos</p>
            </div>
            {% endfor %}
          </div>
          <div id="usersPaginationContainer" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para confirmar eliminación de mensaje -->
<div class="modal fade" id="deleteMessageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-content-elegant">
      <div class="modal-header modal-header-elegant" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white;">
        <h5 class="modal-title">
          <i class="fas fa-trash me-2"></i>Eliminar Mensaje
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <p class="text-primary-dark">¿Estás seguro de que quieres eliminar este mensaje?</p>
        <p class="text-muted small mb-0">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteMessage" style="border-radius: 10px;">
          <i class="fas fa-trash me-2"></i>Eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para confirmar limpiar chat -->
<div class="modal fade" id="clearChatModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-content-elegant">
      <div class="modal-header modal-header-elegant" style="background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%);">
        <h5 class="modal-title" style="color: white;">
          <i class="fas fa-broom me-2"></i>Limpiar Chat
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <p class="text-primary-dark">¿Estás seguro de que quieres eliminar <strong>TODOS</strong> los mensajes del chat?</p>
        <p class="text-muted small mb-0">Esta acción eliminará permanentemente todos los mensajes y no se puede deshacer.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Cancelar</button>
        <button type="button" class="btn btn-warning" id="confirmClearChat" style="border-radius: 10px;">
          <i class="fas fa-broom me-2"></i>Limpiar Todo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para confirmar bloqueo/desbloqueo de usuario -->
<div class="modal fade" id="toggleBlockModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-content-elegant">
      <div class="modal-header modal-header-elegant" id="toggleBlockModalHeader" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white;">
        <h5 class="modal-title" id="toggleBlockModalLabel">
          <span id="toggleBlockAction">Bloquear Usuario</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <p id="toggleBlockMessage" class="text-primary-dark">¿Estás seguro de que quieres bloquear a este usuario?</p>
        <p class="text-muted small mb-0" id="toggleBlockDescription">El usuario no podrá enviar mensajes en el chat.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmToggleBlock" style="border-radius: 10px;">
          <span id="confirmToggleBlockText">Bloquear</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para configurar Filtro ML -->
<div class="modal fade" id="filterConfigModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content modal-content-elegant">
      <div class="modal-header modal-header-elegant" style="background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); color: white;">
        <h5 class="modal-title">
          <i class="fas fa-robot me-2"></i>Configuración de Filtro Inteligente ML
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <ul class="nav nav-tabs mb-3" id="filterTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">
              <i class="fas fa-cog me-1"></i>Configuración
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="palabras-tab" data-bs-toggle="tab" data-bs-target="#palabras" type="button" role="tab">
              <i class="fas fa-ban me-1"></i>Palabras Prohibidas
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="usuarios-bloqueados-tab" data-bs-toggle="tab" data-bs-target="#usuarios-bloqueados" type="button" role="tab">
              <i class="fas fa-user-slash me-1"></i>Usuarios Bloqueados
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="infracciones-tab" data-bs-toggle="tab" data-bs-target="#infracciones" type="button" role="tab">
              <i class="fas fa-exclamation-triangle me-1"></i>Infracciones
            </button>
          </li>
        </ul>

        <div class="tab-content" id="filterTabsContent">
          <!-- Tab: Configuración -->
          <div class="tab-pane fade show active" id="config" role="tabpanel">
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="filterActivo" checked>
                <label class="form-check-label fw-bold" for="filterActivo">
                  Activar Filtro Inteligente ML
                  <br><small class="text-muted fw-normal">Analiza automáticamente mensajes con Machine Learning</small>
                </label>
              </div>
            </div>

            <hr>

            <div class="mb-3">
              <label for="umbralToxicidad" class="form-label fw-bold">
                Umbral de Toxicidad: <span id="umbralValue">0.7</span>
              </label>
              <input type="range" class="form-range" id="umbralToxicidad" min="0" max="1" step="0.05" value="0.7">
              <small class="text-muted">Mayor valor = más estricto. Recomendado: 0.6 - 0.8</small>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Acción al detectar contenido ofensivo:</label>
              <select class="form-select search-box-chat" id="modoAccion">
                <option value="bloquear">Bloquear mensaje</option>
                <option value="advertir">Advertir usuario (permitir mensaje)</option>
                <option value="revisar">Marcar para revisión</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="strikesBloqueo" class="form-label fw-bold">Infracciones para bloqueo automático:</label>
              <input type="number" class="form-control search-box-chat" id="strikesBloqueo" min="1" max="10" value="3">
              <small class="text-muted">Número de infracciones antes de bloquear al usuario automáticamente</small>
            </div>

            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="bloquearEnlaces">
                <label class="form-check-label fw-bold" for="bloquearEnlaces">
                  Bloquear mensajes con enlaces (URLs)
                </label>
              </div>
            </div>

            <button class="btn btn-primary w-100" onclick="saveFilterConfig()" style="border-radius: 10px;">
              <i class="fas fa-save me-2"></i>Guardar Configuración
            </button>
          </div>

          <!-- Tab: Palabras Prohibidas -->
          <div class="tab-pane fade" id="palabras" role="tabpanel">
            <div class="mb-3">
              <label class="form-label fw-bold">Agregar palabra prohibida:</label>
              <div class="input-group">
                <input type="text" class="form-control search-box-chat" id="nuevaPalabra" placeholder="Escribe la palabra...">
                <select class="form-select search-box-chat" id="severidadPalabra" style="max-width: 120px;">
                  <option value="baja">Baja</option>
                  <option value="media" selected>Media</option>
                  <option value="alta">Alta</option>
                </select>
                <button class="btn btn-primary" onclick="addProhibitedWord()" style="border-radius: 10px;">
                  <i class="fas fa-plus"></i> Agregar
                </button>
              </div>
            </div>

            <hr>

            <div id="palabrasProhibidasList" style="max-height: 300px; overflow-y: auto;">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Cargando...
              </div>
            </div>
          </div>

          <!-- Tab: Usuarios Bloqueados -->
          <div class="tab-pane fade" id="usuarios-bloqueados" role="tabpanel">
            <div class="alert" style="background: #EEF2FF; border: none; border-radius: 10px; color: #4338CA;">
              <i class="fas fa-info-circle me-2"></i>
              <strong class="text-primary-dark">Gestión de Usuarios Bloqueados</strong>
              <p class="mb-0 small text-primary-dark">Aquí puedes ver y gestionar todos los usuarios que han sido bloqueados del chat.</p>
            </div>

            <div id="usuariosBloqueadosList" style="max-height: 350px; overflow-y: auto;">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Cargando...
              </div>
            </div>
          </div>

          <!-- Tab: Infracciones -->
          <div class="tab-pane fade" id="infracciones" role="tabpanel">
            <div id="infraccionesList" style="max-height: 400px; overflow-y: auto;">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Cargando...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Búsqueda de mensajes
document.getElementById('searchMessages').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    const messages = document.querySelectorAll('.message-item');

    messages.forEach(message => {
        const messageContent = message.querySelector('p')?.textContent.toLowerCase() || '';
        const userName = message.querySelector('strong')?.textContent.toLowerCase() || '';
        const fullText = messageContent + ' ' + userName;

        if (searchTerm === '' || fullText.includes(searchTerm)) {
            message.style.display = '';
        } else {
            message.style.display = 'none';
        }
    });
});

// Auto-actualizar mensajes cada 2 segundos
console.log('Iniciando sistema de actualización automática de mensajes...');
let isUpdating = false;
let deletedMessagesToday = 0;
let currentFilter = 'all';
let allMessages = [];

// Paginación
let currentMessagesPage = 1;
const messagesPerPage = 20;
let currentUsersPage = 1;
const usersPerPage = 5;

async function updateMessages() {
    if (isUpdating) return;
    isUpdating = true;

    try {
        const response = await fetch('/api/chat/messages/radio-oriente/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        if (response.ok) {
            const data = await response.json();
            const messages = Array.isArray(data) ? data : (data.results || []);
            allMessages = messages;
            updateMessagesContainer(filterMessagesByType(messages));
            updateStatistics(messages);
            updateTopUsers(messages);
        }
    } catch (error) {
        console.error('Error updating messages:', error);
    } finally {
        isUpdating = false;
    }
}

function updateMessagesContainer(messages) {
    const container = document.getElementById('messagesContainer');
    if (!container) return;

    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-comments fa-4x text-muted mb-3 d-block"></i>
                <p class="text-muted mb-0">No hay mensajes en el chat</p>
            </div>
        `;
        return;
    }

    const totalPages = Math.ceil(messages.length / messagesPerPage);
    const startIndex = (currentMessagesPage - 1) * messagesPerPage;
    const endIndex = startIndex + messagesPerPage;
    const paginatedMessages = messages.slice(startIndex, endIndex);

    let messagesHTML = '';
    paginatedMessages.forEach(message => {
        const timeAgo = getTimeAgo(new Date(message.fecha_envio));
        const initials = (message.usuario_nombre || '?').slice(0, 2).toUpperCase();

        messagesHTML += `
            <div class="message-bubble message-item" id="message-${message.id}">
              <div class="d-flex">
                <div class="message-avatar me-3">${initials}</div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <strong class="text-primary-dark" style="font-size: 0.95rem;">${message.usuario_nombre || 'Usuario anónimo'}</strong>
                      <br><small class="text-muted" style="font-size: 0.8rem;">
                        <i class="fas fa-hashtag me-1"></i>${message.sala || 'radio-oriente'} •
                        <i class="fas fa-clock me-1"></i>${timeAgo}
                      </small>
                    </div>
                    <div class="message-actions">
                      <button class="btn btn-action-message btn-action-block toggle-block-btn"
                              data-user-id="${message.id_usuario}"
                              data-user-name="${message.usuario_nombre}"
                              data-blocked="${message.usuario_bloqueado || false}"
                              title="Bloquear usuario">
                        <i class="fas fa-${message.usuario_bloqueado ? 'unlock' : 'ban'}"></i>
                      </button>
                      <button class="btn btn-action-message btn-action-delete delete-message-btn"
                              data-message-id="${message.id}"
                              title="Eliminar mensaje">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <p class="mb-0 text-primary-dark" style="line-height: 1.5;">${escapeHtml(message.contenido)}</p>
                </div>
              </div>
            </div>
        `;
    });

    container.innerHTML = messagesHTML;
    renderMessagesPagination(totalPages);
}

function renderMessagesPagination(totalPages) {
    const paginationContainer = document.getElementById('messagesPaginationContainer');
    if (!paginationContainer) return;

    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }

    let paginationHTML = '<nav><ul class="pagination justify-content-center mb-0">';

    paginationHTML += `
        <li class="page-item ${currentMessagesPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeMessagesPage(${currentMessagesPage - 1}); return false;">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;

    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentMessagesPage - 1 && i <= currentMessagesPage + 1)) {
            paginationHTML += `
                <li class="page-item ${currentMessagesPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changeMessagesPage(${i}); return false;">${i}</a>
                </li>
            `;
        } else if (i === currentMessagesPage - 2 || i === currentMessagesPage + 2) {
            paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    paginationHTML += `
        <li class="page-item ${currentMessagesPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeMessagesPage(${currentMessagesPage + 1}); return false;">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;

    paginationHTML += '</ul></nav>';
    paginationContainer.innerHTML = paginationHTML;
}

function changeMessagesPage(page) {
    currentMessagesPage = page;
    updateMessagesContainer(filterMessagesByType(allMessages));
}

function updateStatistics(messages) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const messagesToday = messages.filter(msg => new Date(msg.fecha_envio) >= today);

    const cards = document.querySelectorAll('.stat-card-chat h3');
    if (cards[0]) cards[0].textContent = messagesToday.length;
    if (cards[1]) cards[1].textContent = new Set(messagesToday.map(msg => msg.id_usuario)).size;
    if (cards[2]) cards[2].textContent = messages.length;
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'hace unos segundos';
    if (seconds < 3600) return `hace ${Math.floor(seconds / 60)} minuto${Math.floor(seconds / 60) !== 1 ? 's' : ''}`;
    if (seconds < 86400) return `hace ${Math.floor(seconds / 3600)} hora${Math.floor(seconds / 3600) !== 1 ? 's' : ''}`;
    return `hace ${Math.floor(seconds / 86400)} día${Math.floor(seconds / 86400) !== 1 ? 's' : ''}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

updateMessages();
setInterval(updateMessages, 2000);

let currentMessageId = null;
let currentUserId = null;
let currentUserName = null;
let currentUserBlocked = false;

document.addEventListener('click', function(e) {
    if (e.target.closest('.delete-message-btn')) {
        const button = e.target.closest('.delete-message-btn');
        currentMessageId = button.getAttribute('data-message-id');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteMessageModal'));
        deleteModal.show();
    }

    if (e.target.closest('.toggle-block-btn')) {
        const button = e.target.closest('.toggle-block-btn');
        currentUserId = button.getAttribute('data-user-id');
        currentUserName = button.getAttribute('data-user-name');
        currentUserBlocked = button.getAttribute('data-blocked') === 'true';

        const modal = document.getElementById('toggleBlockModal');
        const modalHeader = document.getElementById('toggleBlockModalHeader');
        const modalAction = document.getElementById('toggleBlockAction');
        const modalMessage = document.getElementById('toggleBlockMessage');
        const modalDescription = document.getElementById('toggleBlockDescription');
        const confirmBtn = document.getElementById('confirmToggleBlock');
        const confirmBtnText = document.getElementById('confirmToggleBlockText');

        if (currentUserBlocked) {
            modalHeader.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
            modalAction.innerHTML = '<i class="fas fa-unlock me-2"></i>Desbloquear Usuario';
            modalMessage.textContent = `¿Estás seguro de que quieres desbloquear a ${currentUserName}?`;
            modalDescription.textContent = 'El usuario podrá volver a enviar mensajes en el chat.';
            confirmBtn.className = 'btn btn-success';
            confirmBtn.style.borderRadius = '10px';
            confirmBtnText.innerHTML = '<i class="fas fa-unlock me-2"></i>Desbloquear';
        } else {
            modalHeader.style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
            modalAction.innerHTML = '<i class="fas fa-ban me-2"></i>Bloquear Usuario';
            modalMessage.textContent = `¿Estás seguro de que quieres bloquear a ${currentUserName}?`;
            modalDescription.textContent = 'El usuario no podrá enviar mensajes en el chat.';
            confirmBtn.className = 'btn btn-danger';
            confirmBtn.style.borderRadius = '10px';
            confirmBtnText.innerHTML = '<i class="fas fa-ban me-2"></i>Bloquear';
        }

        const toggleBlockModal = new bootstrap.Modal(modal);
        toggleBlockModal.show();
    }
});

function clearAllMessages() {
    const clearModal = new bootstrap.Modal(document.getElementById('clearChatModal'));
    clearModal.show();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type = 'primary') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-info-circle me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

function filterMessagesByType(messages) {
    if (currentFilter === 'blocked') {
        return messages.filter(msg => msg.usuario_bloqueado === true);
    }
    return messages;
}

function filterMessages(type) {
    currentFilter = type;
    document.getElementById('btnTodos').classList.toggle('active', type === 'all');
    document.getElementById('btnBloqueados').classList.toggle('active', type === 'blocked');
    updateMessagesContainer(filterMessagesByType(allMessages));
}

function updateTopUsers(messages) {
    const userCounts = {};
    messages.forEach(msg => {
        if (msg.id_usuario && msg.usuario_nombre) {
            if (!userCounts[msg.id_usuario]) {
                userCounts[msg.id_usuario] = {
                    id: msg.id_usuario,
                    username: msg.usuario_nombre,
                    count: 0,
                    is_blocked: msg.usuario_bloqueado || false
                };
            }
            userCounts[msg.id_usuario].count++;
        }
    });

    const allTopUsers = Object.values(userCounts).sort((a, b) => b.count - a.count);
    const container = document.getElementById('topUsersContainer');
    if (!container) return;

    if (allTopUsers.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-users fa-3x text-muted mb-2"></i>
                <p class="text-muted mb-0">No hay usuarios activos</p>
            </div>
        `;
        document.getElementById('usersPaginationContainer').innerHTML = '';
        return;
    }

    const totalPages = Math.ceil(allTopUsers.length / usersPerPage);
    const startIndex = (currentUsersPage - 1) * usersPerPage;
    const endIndex = startIndex + usersPerPage;
    const paginatedUsers = allTopUsers.slice(startIndex, endIndex);

    let html = '';
    paginatedUsers.forEach(user => {
        const initials = user.username.slice(0, 2).toUpperCase();
        html += `
            <div class="user-item">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div class="user-avatar-small me-3">${initials}</div>
                  <div>
                    <strong class="text-primary-dark" style="font-size: 0.9rem;">${escapeHtml(user.username)}</strong>
                    <br><small class="text-muted" style="font-size: 0.75rem;">
                      <i class="fas fa-comment me-1"></i>${user.count} mensaje${user.count !== 1 ? 's' : ''}
                    </small>
                  </div>
                </div>
                <button class="btn btn-sm ${user.is_blocked ? 'btn-success' : 'btn-danger'} toggle-block-btn"
                        style="border-radius: 8px;"
                        data-user-id="${user.id}"
                        data-user-name="${escapeHtml(user.username)}"
                        data-blocked="${user.is_blocked ? 'true' : 'false'}">
                  <i class="fas fa-${user.is_blocked ? 'unlock' : 'ban'}"></i>
                </button>
              </div>
            </div>
        `;
    });

    container.innerHTML = html;
    renderUsersPagination(totalPages);
}

function renderUsersPagination(totalPages) {
    const paginationContainer = document.getElementById('usersPaginationContainer');
    if (!paginationContainer) return;

    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }

    let paginationHTML = '<nav><ul class="pagination pagination-sm justify-content-center mb-0">';

    paginationHTML += `
        <li class="page-item ${currentUsersPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeUsersPage(${currentUsersPage - 1}); return false;">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;

    for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
            <li class="page-item ${currentUsersPage === i ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changeUsersPage(${i}); return false;">${i}</a>
            </li>
        `;
    }

    paginationHTML += `
        <li class="page-item ${currentUsersPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeUsersPage(${currentUsersPage + 1}); return false;">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;

    paginationHTML += '</ul></nav>';
    paginationContainer.innerHTML = paginationHTML;
}

function changeUsersPage(page) {
    currentUsersPage = page;
    updateMessages();
}

// Event listeners para los modals
document.getElementById('confirmDeleteMessage').addEventListener('click', function() {
    if (!currentMessageId) return;

    fetch(`/api/chat/messages/${currentMessageId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            deletedMessagesToday++;
            document.getElementById('deletedMessagesCount').textContent = deletedMessagesToday;
            showNotification('Mensaje eliminado correctamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('deleteMessageModal')).hide();
            updateMessages();
        } else {
            return response.json().then(data => {
                showNotification('Error: ' + (data.detail || 'No autorizado'), 'danger');
                bootstrap.Modal.getInstance(document.getElementById('deleteMessageModal')).hide();
            });
        }
    })
    .catch(error => {
        showNotification('Error al eliminar el mensaje', 'danger');
        bootstrap.Modal.getInstance(document.getElementById('deleteMessageModal')).hide();
    });
});

document.getElementById('confirmClearChat').addEventListener('click', function() {
    fetch('/dashboard/chat/clear/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ sala: 'radio-oriente' }),
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            deletedMessagesToday += data.deleted_count || 0;
            document.getElementById('deletedMessagesCount').textContent = deletedMessagesToday;
            showNotification(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('clearChatModal')).hide();
            updateMessages();
        } else {
            showNotification('Error: ' + data.message, 'danger');
            bootstrap.Modal.getInstance(document.getElementById('clearChatModal')).hide();
        }
    })
    .catch(error => {
        showNotification('Error al limpiar el chat', 'danger');
        bootstrap.Modal.getInstance(document.getElementById('clearChatModal')).hide();
    });
});

document.getElementById('confirmToggleBlock').addEventListener('click', function() {
    if (!currentUserId) return;

    fetch(`/api/chat/users/${currentUserId}/toggle-block/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('toggleBlockModal')).hide();
            updateMessages();
        } else {
            showNotification('Error: ' + data.message, 'danger');
            bootstrap.Modal.getInstance(document.getElementById('toggleBlockModal')).hide();
        }
    })
    .catch(error => {
        showNotification('Error al cambiar estado del usuario', 'danger');
        bootstrap.Modal.getInstance(document.getElementById('toggleBlockModal')).hide();
    });
});

// ============== FILTRO ML ==============

document.getElementById('umbralToxicidad').addEventListener('input', function(e) {
    document.getElementById('umbralValue').textContent = parseFloat(e.target.value).toFixed(2);
});

function openFilterConfig() {
    const modal = new bootstrap.Modal(document.getElementById('filterConfigModal'));
    modal.show();
    loadFilterConfig();
    loadProhibitedWords();
    loadBlockedUsers();
    loadInfractions();
}

async function loadFilterConfig() {
    try {
        const response = await fetch('/api/chat/filter/config/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        const data = await response.json();
        document.getElementById('filterActivo').checked = data.activo;
        document.getElementById('umbralToxicidad').value = data.umbral_toxicidad;
        document.getElementById('umbralValue').textContent = parseFloat(data.umbral_toxicidad).toFixed(2);
        document.getElementById('bloquearEnlaces').checked = data.bloquear_enlaces;
        document.getElementById('modoAccion').value = data.modo_accion;
        document.getElementById('strikesBloqueo').value = data.strikes_para_bloqueo;
    } catch (error) {
        console.error('Error al cargar configuración:', error);
        showNotification('Error al cargar configuración del filtro', 'danger');
    }
}

async function saveFilterConfig() {
    const config = {
        activo: document.getElementById('filterActivo').checked,
        umbral_toxicidad: parseFloat(document.getElementById('umbralToxicidad').value),
        bloquear_enlaces: document.getElementById('bloquearEnlaces').checked,
        modo_accion: document.getElementById('modoAccion').value,
        strikes_para_bloqueo: parseInt(document.getElementById('strikesBloqueo').value)
    };

    try {
        const response = await fetch('/api/chat/filter/config/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(config)
        });

        const data = await response.json();
        if (data.success) {
            showNotification('Configuración guardada correctamente', 'success');
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    } catch (error) {
        showNotification('Error al guardar configuración', 'danger');
    }
}

async function loadProhibitedWords() {
    const container = document.getElementById('palabrasProhibidasList');
    container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';

    try {
        const response = await fetch('/api/chat/filter/palabras/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.palabras.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">No hay palabras prohibidas configuradas</div>';
            return;
        }

        let html = '<div class="list-group">';
        data.palabras.forEach(palabra => {
            const severidadColors = {'baja': 'info', 'media': 'warning', 'alta': 'danger'};
            const color = severidadColors[palabra.severidad] || 'secondary';

            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escapeHtml(palabra.palabra)}</strong>
                        <span class="badge bg-${color} ms-2">${palabra.severidad}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProhibitedWord(${palabra.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<div class="text-center text-danger py-3">Error al cargar palabras prohibidas</div>';
    }
}

async function addProhibitedWord() {
    const palabra = document.getElementById('nuevaPalabra').value.trim();
    const severidad = document.getElementById('severidadPalabra').value;

    if (!palabra) {
        showNotification('Debes escribir una palabra', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/chat/filter/palabras/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ palabra, severidad })
        });

        const data = await response.json();
        if (data.success) {
            showNotification('Palabra agregada correctamente', 'success');
            document.getElementById('nuevaPalabra').value = '';
            loadProhibitedWords();
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    } catch (error) {
        showNotification('Error al agregar palabra', 'danger');
    }
}

async function deleteProhibitedWord(id) {
    if (!confirm('¿Estás seguro de eliminar esta palabra?')) return;

    try {
        const response = await fetch('/api/chat/filter/palabras/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ id })
        });

        const data = await response.json();
        if (data.success) {
            showNotification('Palabra eliminada correctamente', 'success');
            loadProhibitedWords();
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    } catch (error) {
        showNotification('Error al eliminar palabra', 'danger');
    }
}

async function loadBlockedUsers() {
    const container = document.getElementById('usuariosBloqueadosList');
    container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';

    try {
        const response = await fetch('/api/chat/filter/usuarios-bloqueados/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.usuarios_bloqueados.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-check-circle fa-2x mb-2"></i><p>No hay usuarios bloqueados</p></div>';
            return;
        }

        let html = '<div class="list-group">';
        data.usuarios_bloqueados.forEach(user => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <i class="fas fa-user-slash text-white"></i>
                                </div>
                                <div>
                                    <strong>${escapeHtml(user.username)}</strong>
                                    <br><small class="text-muted">${escapeHtml(user.email)}</small>
                                    <br><small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>${user.infracciones_count} infracción${user.infracciones_count !== 1 ? 'es' : ''}</small>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-success" onclick="unblockUserFromList(${user.id}, '${escapeHtml(user.username)}')">
                            <i class="fas fa-unlock me-1"></i>Desbloquear
                        </button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<div class="text-center text-danger py-3">Error al cargar usuarios bloqueados</div>';
    }
}

async function unblockUserFromList(userId, username) {
    if (!confirm(`¿Estás seguro de desbloquear a ${username}?`)) return;

    try {
        const response = await fetch(`/api/chat/users/${userId}/toggle-block/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        const data = await response.json();
        if (data.success) {
            showNotification(`${username} ha sido desbloqueado correctamente`, 'success');
            loadBlockedUsers();
            updateMessages();
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    } catch (error) {
        showNotification('Error al desbloquear usuario', 'danger');
    }
}

async function loadInfractions() {
    const container = document.getElementById('infraccionesList');
    container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';

    try {
        const response = await fetch('/api/chat/filter/infracciones/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.infracciones.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">No hay infracciones registradas</div>';
            return;
        }

        let html = '<div class="list-group">';
        data.infracciones.forEach(infraccion => {
            const tipoColors = {
                'toxicidad_ml': 'danger',
                'palabra_prohibida': 'warning',
                'enlace_prohibido': 'info',
                'spam': 'secondary'
            };
            const color = tipoColors[infraccion.tipo_infraccion] || 'secondary';
            const fecha = new Date(infraccion.fecha_infraccion).toLocaleString('es-CL');

            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>${escapeHtml(infraccion.usuario_nombre)}</strong>
                            <span class="badge bg-${color} ms-2">${infraccion.tipo_infraccion}</span>
                            ${infraccion.score_toxicidad ? `<span class="badge bg-secondary ms-1">Score: ${(infraccion.score_toxicidad * 100).toFixed(0)}%</span>` : ''}
                        </div>
                        <small class="text-muted">${fecha}</small>
                    </div>
                    <p class="mb-1 text-muted small">${escapeHtml(infraccion.mensaje_original.substring(0, 100))}${infraccion.mensaje_original.length > 100 ? '...' : ''}</p>
                    <small class="text-muted">Acción: ${infraccion.accion_tomada}</small>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<div class="text-center text-danger py-3">Error al cargar infracciones</div>';
    }
}
</script>
{% endblock %}
