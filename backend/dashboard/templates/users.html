{% extends 'dashboard/base.html' %} {% block page_title %}Gestión de Usuarios{%
endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>
    <i class="fas fa-users text-primary me-2"></i>
    Gestión de
    <button
      type="button"
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#addUserModal"
    >
      <i class="fas fa-plus me-2"></i>Agregar Usuario
    </button>
  </h2>
</div>

<div class="card">
  <div class="card-header bg-white">
    <div class="row align-items-center">
      <div class="col">
        <h5 class="mb-0">Lista de Usuarios</h5>
      </div>
      <div class="col-auto">
        <div class="input-group">
          <input
            type="text"
            class="form-control"
            placeholder="Buscar usuarios..."
            id="searchUsers"
          />
          <button class="btn btn-outline-secondary" type="button">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Usuario</th>
            <th>Correo</th>
            <th>Nombre</th>
            <th>Rol</th>
            <th>Fecha Registro</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div
                  class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3"
                  style="width: 40px; height: 40px"
                >
                  <i class="fas fa-user text-white"></i>
                </div>
                <strong>{{ user.usuario }}</strong>
              </div>
            </td>
            <td>{{ user.correo }}</td>
            <td>{{ user.nombre }}</td>
            <td>
              {% if user.rol_id %}
              <span class="badge bg-info">{{ user.rol_id.nombre }}</span>
              {% else %}
              <span class="badge bg-secondary">Sin rol</span>
              {% endif %}
            </td>
            <td>{{ user.fecha_creacion|date:"d/m/Y H:i" }}</td>
            <td>
              {% if user.is_active %}
              <span class="badge bg-success">Activo</span>
              {% else %}
              <span class="badge bg-danger">Inactivo</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group" role="group">
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#editUserModal"
                  data-user-id="{{ user.id }}"
                  data-user-nombre="{{ user.nombre }}"
                  data-user-usuario="{{ user.usuario }}"
                  data-user-correo="{{ user.correo }}"
                  data-user-staff="{{ user.is_staff }}"
                  data-user-active="{{ user.is_active }}"
                >
                  <i class="fas fa-edit"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  onclick="deleteItem('{% url 'delete_user' user.id %}', '{{ user.usuario|escapejs }}')"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center py-4">
              <i class="fas fa-users fa-3x text-muted mb-3"></i>
              <p class="text-muted">No hay usuarios registrados</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para agregar usuario -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Nuevo Usuario</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form method="post" action="{% url 'create_user' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="nombre" class="form-label">Nombre Completo</label>
            <input type="text" class="form-control" name="nombre" required />
          </div>
          <div class="mb-3">
            <label for="usuario" class="form-label">Usuario</label>
            <input type="text" class="form-control" name="usuario" required />
          </div>
          <div class="mb-3">
            <label for="correo" class="form-label">Correo Electrónico</label>
            <input type="email" class="form-control" name="correo" required />
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Contraseña</label>
            <input
              type="password"
              class="form-control"
              name="password"
              required
            />
          </div>
          <div class="form-check mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              name="is_staff"
              id="is_staff"
            />
            <label class="form-check-label" for="is_staff">
              Usuario Administrador
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">Crear Usuario</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para Editar Usuario -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Usuario</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form method="post" id="editUserForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit-nombre" class="form-label">Nombre Completo</label>
            <input
              type="text"
              class="form-control"
              name="nombre"
              id="edit-nombre"
              required
            />
          </div>
          <div class="mb-3">
            <label for="edit-usuario" class="form-label">Usuario</label>
            <input
              type="text"
              class="form-control"
              name="usuario"
              id="edit-usuario"
              required
            />
          </div>
          <div class="mb-3">
            <label for="edit-correo" class="form-label"
              >Correo Electrónico</label
            >
            <input
              type="email"
              class="form-control"
              name="correo"
              id="edit-correo"
              required
            />
          </div>
          <div class="mb-3">
            <label for="edit-password" class="form-label"
              >Nueva Contraseña (opcional)</label
            >
            <input
              type="password"
              class="form-control"
              name="password"
              id="edit-password"
            />
            <small class="form-text text-muted"
              >Dejar vacío para mantener la contraseña actual</small
            >
          </div>
          <div class="form-check mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              name="is_staff"
              id="edit-is_staff"
            />
            <label class="form-check-label" for="edit-is_staff">
              Usuario Administrador
            </label>
          </div>
          <div class="form-check mb-3">
            <input
              class="form-check-input"
              type="checkbox"
              name="is_active"
              id="edit-is_active"
            />
            <label class="form-check-label" for="edit-is_active">
              Usuario Activo
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            Actualizar Usuario
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  //funcion para editar usuario
  document.addEventListener("DOMContentLoaded", function () {
    //manejar click en botones de editar
    document
      .querySelectorAll('[data-bs-target="#editUserModal"]')
      .forEach((button) => {
        button.addEventListener("click", function () {
          const userId = this.getAttribute("data-user-id");
          const nombre = this.getAttribute("data-user-nombre");
          const usuario = this.getAttribute("data-user-usuario");
          const correo = this.getAttribute("data-user-correo");
          const isStaff = this.getAttribute("data-user-staff") === "True";
          const isActive = this.getAttribute("data-user-active") === "True";

          //llenar formulario
          document.getElementById("edit-nombre").value = nombre;
          document.getElementById("edit-usuario").value = usuario;
          document.getElementById("edit-correo").value = correo;
          document.getElementById("edit-is_staff").checked = isStaff;
          document.getElementById("edit-is_active").checked = isActive;

          //actualizar action del formulario
          document.getElementById(
            "editUserForm"
          ).action = `/dashboard/users/edit/${userId}/`;
        });
      });
  });
</script>
{% endblock %} {% block scripts %}
<script>
  //busqueda de usuarios
  document
    .getElementById("searchUsers")
    .addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll("tbody tr");

      rows.forEach((row) => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? "" : "none";
      });
    });
</script>
{% endblock %}
