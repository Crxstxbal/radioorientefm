{% extends 'dashboard/base.html' %} 
{% block page_title %} Dashboard Principal
{%endblock %} 
{% block content %}
<div class="row mb-4">
  <!-- Estadísticas principales -->
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stat-card users">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-uppercase mb-1">
              Usuarios
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ total_users }}</div>
            <div class="text-xs mt-1">+{{ new_users_week }} esta semana</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-users fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stat-card posts">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-uppercase mb-1">
              Artículos
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ total_posts }}</div>
            <div class="text-xs mt-1">+{{ new_posts_week }} esta semana</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-blog fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stat-card programs">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-uppercase mb-1">
              Programas
            </div>
            <div class="h5 mb-0 font-weight-bold">{{ total_programs }}</div>
            <div class="text-xs mt-1">Activos</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-broadcast-tower fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stat-card">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-uppercase mb-1">
              Suscriptores
            </div>
            <div class="h5 mb-0 font-weight-bold">
              {{ total_subscriptions }}
            </div>
            <div class="text-xs mt-1">+{{ new_messages_week }} mensajes</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-envelope fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Artículos populares -->
  <div class="col-lg-8 mb-4">
    <div class="card">
      <div class="card-header bg-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-fire text-danger me-2"></i>
          Artículos Más Populares
        </h5>
      </div>
      <div class="card-body">
        {% if popular_posts %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Título</th>
                <th>Autor</th>
                <th>Comentarios</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody>
              {% for post in popular_posts %}
              <tr>
                <td>
                  <strong>{{ post.titulo|truncatechars:50 }}</strong>
                  {% if post.publicado %}
                  <span class="badge bg-success ms-2">Publicado</span>
                  {% else %}
                  <span class="badge bg-warning ms-2">Borrador</span>
                  {% endif %}
                </td>
                <td>{{ post.autor_nombre|default:"Sin autor" }}</td>
                <td>
                  <span class="badge bg-primary">{{ post.comment_count }}</span>
                </td>
                <td>{{ post.fecha_creacion|date:"d/m/Y" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-blog fa-3x text-muted mb-3"></i>
          <p class="text-muted">No hay artículos publicados aún</p>
          <a href="{% url 'dashboard_blog' %}" class="btn btn-primary"
            >Crear Artículo</a
          >
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Mensajes de contacto recientes -->
  <div class="col-lg-4 mb-4">
    <div class="card">
      <div class="card-header bg-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-envelope text-info me-2"></i>
          Mensajes Recientes
        </h5>
      </div>
      <div class="card-body">
        {% if recent_contacts %} {% for contact in recent_contacts %}
        <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
          <div class="flex-shrink-0">
            <div
              class="bg-light rounded-circle d-flex align-items-center justify-content-center"
              style="width: 40px; height: 40px"
            >
              <i class="fas fa-user text-muted"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <h6 class="mb-1">{{ contact.nombre }}</h6>
            <p class="mb-1 small text-muted">
              {{ contact.mensaje|truncatechars:60 }}
            </p>
            <small class="text-muted"
              >{{ contact.fecha_creacion|timesince }} ago</small
            >
          </div>
        </div>
        {% endfor %}
        <div class="text-center">
          <a href="#" class="btn btn-outline-primary btn-sm">Ver Todos</a>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
          <p class="text-muted">No hay mensajes recientes</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Gráfico de actividad -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-line text-success me-2"></i>
          Actividad Reciente
        </h5>
      </div>
      <div class="card-body">
        <canvas id="activityChart" height="100"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}

<script>
  // Gráfico de actividad
  const ctx = document.getElementById("activityChart").getContext("2d");
  const activityChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"],
      datasets: [
        {
          label: "Usuarios Nuevos",
          data: [0, 8, 12, 6, 15, 10, 7],
          borderColor: "#3b82f6",
          backgroundColor: "rgba(59, 130, 246, 0.1)",
          tension: 0.4,
        },
        {
          label: "Artículos",
          data: [0, 3, 5, 2, 4, 6, 3],
          borderColor: "#10b981",
          backgroundColor: "rgba(16, 185, 129, 0.1)",
          tension: 0.4,
        },
        {
          label: "Mensajes",
          data: [0, 15, 20, 18, 25, 22, 19],
          borderColor: "#dc2626",
          backgroundColor: "rgba(220, 38, 38, 0.1)",
          tension: 0.4,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "top",
        },
      },
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  // Actualizar estadísticas cada 30 segundos
  setInterval(function () {
    fetch('{% url "api_dashboard_stats" %}')
      .then((response) => response.json())
      .then((data) => {
        // Actualizar las tarjetas de estadísticas si es necesario
        console.log("Stats updated:", data);
      });
  }, 30000);
</script>
{% endblock %}
